<!DOCTYPE html>
<html lang="">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>KeyTest</title>

  <style>
    body {
      background: #20262E;
      padding: 20px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    }

    #app {
      background: #fff;
      border-radius: 4px;
      padding: 20px;
      transition: all 0.2s;
    }

    li {
      margin: 8px 0;
    }

    h2 {
      font-weight: bold;
      margin-bottom: 15px;
    }

    del {
      color: rgba(0, 0, 0, 0.3);
    }
  </style>
</head>

<body>
  <noscript>
    <strong>We're sorry but <%= htmlWebpackPlugin.options.title %> doesn't work properly without JavaScript enabled.
        Please enable it to continue.</strong>
  </noscript>
  <div id="app">
    <h2>Latency 정보</h2>
    <button onclick="remove_all_log()">전부 지우기</button>
    <ol id="key_event_list">
    </ol>
  </div>

  <script>
    const events = []

    // https://stackoverflow.com/questions/24004791/what-is-the-debounce-function-in-javascript
    function debounce(func, wait, immediate) {
      let timeout
      return function () {
        const context = args = arguments
        const later = function () {
          timeout = null
          if (!immediate) func.apply(context, args)
        }
        const callNow = immediate && !timeout
        clearTimeout(timeout)
        timeout = setTimeout(later, wait)
        if (callNow) func.apply(context, args)
      }
    }


    const update_list = debounce(() => {
      const key_event_list = document.getElementById('key_event_list')
      let htmlSegments = []
      for (const ev of events) {
        htmlSegments.push('<li>')
        htmlSegments.push(`${ev[0]}(${ev[1]}): ${(ev[2] - events[0][2]).toFixed(4)}`)
      }
      key_event_list.innerHTML = htmlSegments.join('')
    }, 50, false)

    ///

    function remove_all_log() {
      events.length = 0
      update_list()
    }

    const keyPressed = {}

    function on_key(ev) {
      if (ev.repeat) return

      const now = (performance.now()) / 1000
      if (ev.type == 'keydown') {
        if (!keyPressed[ev.key]) {
          keyPressed[ev.key] = true
          events.push([ev.type, ev.key, now])
        }
      } else if (ev.type == 'keyup') {
        keyPressed[ev.key] = false
        events.push([ev.type, ev.key, now])
      }

      update_list()
    }

    document.addEventListener('keydown', on_key)
    document.addEventListener('keyup', on_key)
  </script>
</body>

</html>