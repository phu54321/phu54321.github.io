<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>KeyTest</title>

  <script src="coopcoep.js"></script>
  <link href="app.css" rel="stylesheet" />
</head>

<body>
  <noscript>
    <strong>We're sorry but <%= htmlWebpackPlugin.options.title %> doesn't work properly without JavaScript enabled.
        Please enable it to continue.</strong>
  </noscript>
  <div id="app">
    <div class="container">
      <div class="header">
        <h2>Keyboard Tester</h2>
        <div class="author">By trgk(<a href="https://github.com/phu54321/">https://github.com/phu54321/</a>)</div>
      </div>

      <div id="keyboard-layout">
        <div class="row">
          <div class="section-left">
            <div class="btn" data-keycode="Escape">ESC</div>
            <div class="spacer"></div>
            <div class="btn" data-keycode="F1">F1</div>
            <div class="btn" data-keycode="F2">F2</div>
            <div class="btn" data-keycode="F3">F3</div>
            <div class="btn" data-keycode="F4">F4</div>
            <div class="spacer"></div>
            <div class="btn" data-keycode="F5">F5</div>
            <div class="btn" data-keycode="F6">F6</div>
            <div class="btn" data-keycode="F7">F7</div>
            <div class="btn" data-keycode="F8">F8</div>
            <div class="spacer"></div>
            <div class="btn" data-keycode="F9">F9</div>
            <div class="btn" data-keycode="F10">F10</div>
            <div class="btn" data-keycode="F11">F11</div>
            <div class="btn" data-keycode="F12">F12</div>
          </div>
          <div class="section-padding"></div>
          <div class="section-middle">
            <div class="btn" data-keycode="PrintScreen">Print Screen</div>
            <div class="btn" data-keycode="ScrollLock">Scroll<br>Lock</div>
            <div class="btn" data-keycode="Pause">Pause</div>
          </div>
          <div class="section-padding"></div>
          <div class="section-right"></div>
        </div>

        <div class="row">
          <div class="section-left">
            <div class="btn" data-keycode="Backquote">~<br>`</div>
            <div class="btn" data-keycode="Digit1">!<br>1</div>
            <div class="btn" data-keycode="Digit2">@<br>2</div>
            <div class="btn" data-keycode="Digit3">#<br>3</div>
            <div class="btn" data-keycode="Digit4">$<br>4</div>
            <div class="btn" data-keycode="Digit5">%<br>5</div>
            <div class="btn" data-keycode="Digit6">^<br>6</div>
            <div class="btn" data-keycode="Digit7">&<br>7</div>
            <div class="btn" data-keycode="Digit8">*<br>8</div>
            <div class="btn" data-keycode="Digit9">(<br>9</div>
            <div class="btn" data-keycode="Digit0">)<br>0</div>
            <div class="btn" data-keycode="Minus">_<br>-</div>
            <div class="btn" data-keycode="Equal">+<br>+</div>
            <div class="btn" data-keycode="Backspace">Back</div>
          </div>
          <div class="section-padding"></div>
          <div class="section-middle">
            <div class="btn" data-keycode="Insert">Insert</div>
            <div class="btn" data-keycode="Home">Home</div>
            <div class="btn" data-keycode="PageUp">Page<br>Up</div>
          </div>
          <div class="section-padding"></div>
          <div class="section-right">
            <div class="btn" data-keycode="NumLock">Num<br>Lock</div>
            <div class="btn" data-keycode="NumpadDivide">/</div>
            <div class="btn" data-keycode="NumpadMultiply">*</div>
            <div class="btn" data-keycode="NumpadSubtract">-</div>
          </div>
        </div>

        <div class="row">
          <div class="section-left">
            <div class="btn" data-keycode="Tab">Tab</div>
            <div class="btn" data-keycode="KeyQ">Q</div>
            <div class="btn" data-keycode="KeyW">W</div>
            <div class="btn" data-keycode="KeyE">E</div>
            <div class="btn" data-keycode="KeyR">R</div>
            <div class="btn" data-keycode="KeyT">T</div>
            <div class="btn" data-keycode="KeyY">Y</div>
            <div class="btn" data-keycode="KeyU">U</div>
            <div class="btn" data-keycode="KeyI">I</div>
            <div class="btn" data-keycode="KeyO">O</div>
            <div class="btn" data-keycode="KeyP">P</div>
            <div class="btn" data-keycode="BracketLeft">{<br>[</div>
            <div class="btn" data-keycode="BracketRight">}<br>]</div>
            <div class="btn" data-keycode="Backslash">|<br>\</div>
          </div>
          <div class="section-padding"></div>
          <div class="section-middle">
            <div class="btn" data-keycode="Delete">Delete</div>
            <div class="btn" data-keycode="End">End</div>
            <div class="btn" data-keycode="PageDown">Page<br>Down</div>
          </div>
          <div class="section-padding"></div>
          <div class="section-right">
            <div class="btn" data-keycode="Numpad7">7<br>Home</div>
            <div class="btn" data-keycode="Numpad8">8<br>↑</div>
            <div class="btn" data-keycode="Numpad9">9<br>PgUp</div>
            <div class="btn" data-keycode="NumpadAdd">+</div>
          </div>
        </div>
        <div class="row">
          <div class="section-left">
            <div class="btn btn-2" data-keycode="CapsLock">Caps<br>Lock</div>
            <div class="btn" data-keycode="KeyA">A</div>
            <div class="btn" data-keycode="KeyS">S</div>
            <div class="btn" data-keycode="KeyD">D</div>
            <div class="btn" data-keycode="KeyF">F</div>
            <div class="btn" data-keycode="KeyG">G</div>
            <div class="btn" data-keycode="KeyH">H</div>
            <div class="btn" data-keycode="KeyJ">J</div>
            <div class="btn" data-keycode="KeyK">K</div>
            <div class="btn" data-keycode="KeyL">L</div>
            <div class="btn" data-keycode="Semicolon">:<br>;</div>
            <div class="btn" data-keycode="Quote">"<br>'</div>
            <div class="btn btn-2" data-keycode="Enter">Enter</div>
          </div>
          <div class="section-padding"></div>
          <div class="section-middle"></div>
          <div class="section-padding"></div>
          <div class="section-right">
            <div class="btn" data-keycode="Numpad4">4<br>←</div>
            <div class="btn" data-keycode="Numpad5">5<br>&nbsp;</div>
            <div class="btn" data-keycode="Numpad6">6<br>→</div>
            <div class="btn" data-keycode="NumpadComma">
              <!-- Since .btn aligns items with `display:flex`, every text
              should be enclosed in a single element. Here `<div>` -->
              <div>,<br><span class="nonemphasis">(Rare)</span></div>
            </div>
          </div>
        </div>

        <div class="row">
          <div class="section-left">
            <div class="btn btn-2" data-keycode="ShiftLeft">LShift</div>
            <div class="btn" data-keycode="KeyZ">Z</div>
            <div class="btn" data-keycode="KeyX">X</div>
            <div class="btn" data-keycode="KeyC">C</div>
            <div class="btn" data-keycode="KeyV">V</div>
            <div class="btn" data-keycode="KeyB">B</div>
            <div class="btn" data-keycode="KeyN">N</div>
            <div class="btn" data-keycode="KeyM">M</div>
            <div class="btn" data-keycode="Comma">&lt;<br>,</div>
            <div class="btn" data-keycode="Period">&gt;<br>.</div>
            <div class="btn" data-keycode="Slash">?<br>/</div>
            <div class="btn btn-2" data-keycode="ShiftRight">RShift</div>
          </div>
          <div class="section-padding"></div>
          <div class="section-middle">
            <div class="spacer"></div>
            <div class="btn" data-keycode="ArrowUp">↑</div>
            <div class="spacer"></div>
          </div>
          <div class="section-padding"></div>
          <div class="section-right">
            <div class="btn" data-keycode="Numpad1">1<br>End</div>
            <div class="btn" data-keycode="Numpad2">2<br>↓</div>
            <div class="btn" data-keycode="Numpad3">3<br>PgDn</div>
            <div class="btn" data-keycode="NumpadEnter">Enter</div>
          </div>
        </div>

        <div class="row">
          <div class="section-left">
            <div class="btn" data-keycode="ControlLeft">LCtrl</div>
            <div class="btn" data-keycode="MetaLeft">LWin</div>
            <div class="btn" data-keycode="AltLeft">LAlt</div>
            <div class="btn btn-5" data-keycode="Space">Space</div>
            <div class="btn" data-keycode="AltRight">RAlt</div>
            <div class="btn" data-keycode="MetaRight">RWin</div>
            <div class="btn" data-keycode="ContextMenu">RMenu</div>
            <div class="btn" data-keycode="ControlRight">RCtrl</div>
          </div>
          <div class="section-padding"></div>
          <div class="section-middle">
            <div class="btn" data-keycode="ArrowLeft">←</div>
            <div class="btn" data-keycode="ArrowDown">↓</div>
            <div class="btn" data-keycode="ArrowRight">→</div>
          </div>
          <div class="section-padding"></div>
          <div class="section-right">
            <div class="btn btn-2" data-keycode="Numpad0">0</div>
            <div class="btn" data-keycode="NumpadDecimal">,</div>
            <div class="spacer"></div>
          </div>
        </div>
      </div>
      <div class="event-list">
        <button onclick="removeAllLog()">Remove All logs</button>
        <table class="event-table" id="eventTable">
          <tr class="head">
            <th>Type</th>
            <th>Code</th>
            <th>Time (ms)</th>
            <th>Delta (ms)</th>
          </tr>
        </table>
      </div>
    </div>
  </div>


  <script>
    const events = []

    // https://stackoverflow.com/questions/24004791/what-is-the-debounce-function-in-javascript
    let itemChanged = 0
    let lastUpdatedItemIndex = -1
    let keyLastEventTypeMap = {}

    function issueItemChange() {
      itemChanged = 2
    }

    function updateList() {
      if (!itemChanged) return
      if (itemChanged) {
        itemChanged--
        if (itemChanged != 0) return
      }

      const eventTableElement = document.getElementById('eventTable')
      for (const el of document.getElementsByClassName('btn')) {
        const keycode = el.dataset.keycode
        el.classList.remove('event-keydown')
        el.classList.remove('event-keyup')
        if (keyLastEventTypeMap[keycode]) {
          el.classList.add(`event-${keyLastEventTypeMap[keycode]}`)
        }
      }

      if (events.length > 0) {
        const firstEventTime = events[0].now

        for (let i = lastUpdatedItemIndex + 1; i < events.length; i++) {
          const ev = events[i]
          const time = ev.now - firstEventTime
          const delta = (i === 0) ? null : ev.now - events[i - 1].now

          const trElement = document.createElement('tr')
          const td0 = document.createElement('td')
          td0.innerText = `${ev.type}`
          const td1 = document.createElement('td')
          td1.innerText = `${ev.code}`
          const td2 = document.createElement('td')
          td2.innerText = `${(time * 1000).toFixed(2)}`
          const td3 = document.createElement('td')
          if (delta === null);
          else {
            td3.innerText = `${(delta * 1000).toFixed(2)}`
          }

          trElement.appendChild(td0)
          trElement.appendChild(td1)
          trElement.appendChild(td2)
          trElement.appendChild(td3)
          trElement.classList.add('item')
          trElement.classList.add(`type-${ev.type}`)

          eventTableElement.appendChild(trElement)

          lastUpdatedItemIndex = i
        }
      }
    }

    function animationRunner() {
      updateList()
      window.requestAnimationFrame(animationRunner)
    }
    window.requestAnimationFrame(animationRunner)

    ///

    function removeAllLog() {
      events.length = 0
      const eventTableElement = document.getElementById('eventTable')
      eventTableElement.querySelectorAll('tr.item').forEach(el => el.remove())
      lastUpdatedItemIndex = -1
      keyLastEventTypeMap = {}
      issueItemChange()
    }

    const keyPressed = {}

    function onKey(ev) {
      if (ev.repeat) return

      const now = (performance.now()) / 1000
      if (ev.type == 'keydown') {
        if (!keyPressed[ev.code]) {
          keyPressed[ev.code] = true
          events.push({
            type: ev.type,
            code: ev.code,
            now
          })
          keyLastEventTypeMap[ev.code] = ev.type
        }
      } else if (ev.type == 'keyup') {
        keyPressed[ev.code] = false
        events.push({
          type: ev.type,
          code: ev.code,
          now
        })
        keyLastEventTypeMap[ev.code] = ev.type
      }

      issueItemChange()
      ev.stopPropagation()
      ev.preventDefault()
    }

    document.addEventListener('keydown', onKey)
    document.addEventListener('keyup', onKey)
  </script>
</body>

</html>